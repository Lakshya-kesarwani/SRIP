{% extends "base.html" %}

{% block title %}Register{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Register</h2>
    <form id="registerForm" method="POST">
        <input type="text" name="user_name" placeholder="Full Name" required class="form-control mb-2">
        <input type="email" name="user_email" placeholder="Email" required class="form-control mb-2">
        <input type="password" name="user_pass" placeholder="Password" required class="form-control mb-2">
        <button type="submit" class="btn btn-primary">Register</button>
    </form>

    <!-- OTP Section (Initially Hidden) -->
    <div id="otpSection" class="mt-4" style="display: none;">
        <h3>Verify Your OTP</h3>
        <p>We have sent an OTP to your email. Please check your inbox (or spam folder) and enter it below:</p>
        <input type="text" id="otpInput" placeholder="Enter OTP" required class="form-control mb-2">
        <button id="verifyOtpBtn" class="btn btn-success">Verify</button>
        <p id="errorMsg" class="text-danger mt-2" style="display: none;">Invalid OTP, please try again.</p>
    </div>
</div>

<script>
    document.getElementById("registerForm").addEventListener("submit", function (event) {
        event.preventDefault();
        let formData = new FormData(this);

        fetch("{{ url_for('auth.register') }}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("registerForm").style.display = "none";
                document.getElementById("otpSection").style.display = "block";
            } else {
                alert("Error: " + data.message);
            }
        });
    });

    document.getElementById("verifyOtpBtn").addEventListener("click", function () {
        let otpValue = document.getElementById("otpInput").value;

        fetch("{{ url_for('auth.verify_otp') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ otp: otpValue })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Registration Successful!");
                window.location.href = "/";
            } else {
                document.getElementById("errorMsg").style.display = "block";
            }
        });
    });
</script>

{% endblock %}
